<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Ledger</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <!-- Load PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    
    <style>
        /* Simple dark mode theme */
        :root {
            --bg-primary: #1f2937; /* gray-800 */
            --bg-secondary: #374151; /* gray-700 */
            --bg-tertiary: #4b5563; /* gray-600 */
            --text-primary: #f3f4f6; /* gray-100 */
            --text-secondary: #d1d5db; /* gray-300 */
            --accent: #3b82f6; /* blue-500 */
            --accent-hover: #2563eb; /* blue-600 */
            --danger: #ef4444; /* red-500 */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Active tab style */
        .tab-button.active {
            background-color: var(--accent);
            color: white;
            font-weight: 600;
        }

        /* Form elements */
        .form-input {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            width: 100%;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .form-select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: var(--accent);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: #5a6573;
        }
        
        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--bg-tertiary);
            white-space: nowrap;
        }
        .data-table th {
            background-color: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        .data-table tbody tr:hover {
            background-color: var(--bg-secondary);
        }
    </style>
</head>
<body class="h-full flex">

    <!-- Sidebar Navigation -->
    <nav class="w-64 h-full bg-gray-900 p-4 flex flex-col flex-shrink-0">
        <div class="flex items-center gap-3 px-2 mb-6">
            <!-- Replace with Lucide icon -->
            <svg id="icon-book" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white h-8 w-8"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg>
            <span class="text-xl font-bold text-white">Ledger App</span>
        </div>
        <ul class="flex flex-col gap-2">
            <li><button onclick="showTab('dashboard')" class="tab-button active w-full text-left flex items-center gap-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700">
                <svg id="icon-layout" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"></rect><line x1="3" x2="21" y1="9" y2="9"></line><line x1="9" x2="9" y1="21" y2="9"></line></svg>
                Dashboard
            </button></li>
            <li><button onclick="showTab('newTransaction')" class="tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700">
                <svg id="icon-plus" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>
                New Transaction
            </button></li>
            <li><button onclick="showTab('transactions')" class="tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700">
                <svg id="icon-search" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>
                Search Transactions
            </button></li>
            <li><button onclick="showTab('customers')" class="tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700">
                <svg id="icon-users" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Customers
            </button></li>
            <li><button onclick="showTab('products')" class="tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700">
                <svg id="icon-package" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="16.5" x2="7.5" y1="9.4" y2="9.4"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" x2="12" y1="22.08" y2="12"></line></svg>
                Products
            </button></li>
            <li><button onclick="showTab('import')" class="tab-button w-full text-left flex items-center gap-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700">
                <svg id="icon-import" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"></path><path d="m19 10-7 7-7-7"></path><path d="M3 17v2a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-2"></path></svg>
                Data Import
            </button></li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 h-full overflow-y-auto p-8">
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h1 class="text-3xl font-bold mb-6">Dashboard</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-gray-700 p-6 rounded-lg shadow-lg">
                    <h2 class="text-sm font-medium text-gray-300 uppercase">Total Transactions</h2>
                    <p id="total-transactions" class="text-3xl font-bold mt-2">0</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-lg shadow-lg">
                    <h2 class="text-sm font-medium text-gray-300 uppercase">Total Credit (Veresiye)</h2>
                    <p id="total-credit" class="text-3xl font-bold mt-2">0.00 TL</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-lg shadow-lg">
                    <h2 class="text-sm font-medium text-gray-300 uppercase">Total Sales (Satış)</h2>
                    <p id="total-sales" class="text-3xl font-bold mt-2">0.00 TL</p>
                </div>
                <div class="bg-gray-700 p-6 rounded-lg shadow-lg">
                    <h2 class="text-sm font-medium text-gray-300 uppercase">Unique Customers</h2>
                    <p id="total-customers" class="text-3xl font-bold mt-2">0</p>
                </div>
            </div>
            
            <div class="mt-8 bg-gray-700 p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Customer Balances</h2>
                <div class="max-h-96 overflow-y-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Total Spent</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="customer-balances-table">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- New Transaction Tab -->
        <div id="newTransaction" class="tab-content" style="display: none;">
            <h1 class="text-3xl font-bold mb-6">New Transaction</h1>
            <form id="transaction-form" class="max-w-2xl grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-700 p-6 rounded-lg shadow-lg">
                <!-- Data Lists for autocomplete -->
                <datalist id="customer-list"></datalist>
                <datalist id="product-list"></datalist>

                <div>
                    <label for="t-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="t-date" class="form-input" required>
                </div>
                <div>
                    <label for="t-customer" class="block text-sm font-medium text-gray-300 mb-1">Customer Name</label>
                    <input type="text" id="t-customer" class="form-input" list="customer-list" placeholder="Start typing..." required>
                </div>
                <div>
                    <label for="t-type" class="block text-sm font-medium text-gray-300 mb-1">Type (Veresiye/Satış)</label>
                    <select id="t-type" class="form-select" required>
                        <option value="VERESİYE">VERESİYE (Credit)</option>
                        <option value="SATIŞ">SATIŞ (Sale)</option>
                        <option value="İADE">İADE (Return)</option>
                        <option value="İKİSİDE">İKİSİDE (Both)</option>
                    </select>
                </div>
                <div>
                    <label for="t-product-type" class="block text-sm font-medium text-gray-300 mb-1">Product Type (Malın Cinsi)</label>
                    <select id="t-product-type" class="form-select">
                        <option value="İLAÇ">İLAÇ (Pesticide)</option>
                        <option value="GÜBRE">GÜBRE (Fertilizer)</option>
                        <option value="KÖMÜR">KÖMÜR (Coal)</option>
                        <option value="TOHUM">TOHUM (Seed)</option>
                        <option value="FİDE">FİDE (Seedling)</option>
                        <option value="ARI">ARI (Bee)</option>
                        <option value="DİĞER">DİĞER (Other)</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="t-product-name" class="block text-sm font-medium text-gray-300 mb-1">Product Name (Çeşit)</label>
                    <input type="text" id="t-product-name" class="form-input" list="product-list" placeholder="Start typing...">
                </div>
                <div>
                    <label for="t-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantity (Miktar)</label>
                    <input type="number" id="t-quantity" class="form-input" min="0" step="any" value="1">
                </div>
                <div>
                    <label for="t-unit" class="block text-sm font-medium text-gray-300 mb-1">Unit (Adet)</label>
                    <select id="t-unit" class="form-select">
                        <option value="TANE">TANE (Piece)</option>
                        <option value="ÇUVAL">ÇUVAL (Sack)</option>
                        <option value="KİLOGRAM">KİLOGRAM (Kg)</option>
                        <option value="KOVAN">KOVAN (Hive)</option>
                        <option value="TORBA">TORBA (Bag)</option>
                        <option value="DOLU">DOLU (Full)</option>
                        <option value="TON">TON (Ton)</option>
                    </select>
                </div>
                <div>
                    <label for="t-price" class="block text-sm font-medium text-gray-300 mb-1">Unit Price (Fiyat)</label>
                    <input type="number" id="t-price" class="form-input" min="0" step="any" placeholder="0.00">
                </div>
                <div>
                    <label for="t-total" class="block text-sm font-medium text-gray-300 mb-1">Total (Toplam)</label>
                    <input type="text" id="t-total" class="form-input" placeholder="0.00 TL" readonly>
                </div>
                <div class="md:col-span-2 flex justify-end gap-4">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('transaction-form').reset()">Clear</button>
                    <button type="submit" class="btn btn-primary">
                        <svg id="icon-save" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Save Transaction
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Search Transactions Tab -->
        <div id="transactions" class="tab-content" style="display: none;">
            <h1 class="text-3xl font-bold mb-6">Search Transactions</h1>
            <!-- Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 bg-gray-700 p-4 rounded-lg">
                <div>
                    <label for="f-customer" class="block text-sm font-medium text-gray-300 mb-1">Customer</label>
                    <input type="text" id="f-customer" class="form-input" placeholder="Search by name...">
                </div>
                <div>
                    <label for="f-type" class="block text-sm font-medium text-gray-300 mb-1">Type</label>
                    <select id="f-type" class="form-select">
                        <option value="">All</option>
                        <option value="VERESİYE">VERESİYE</option>
                        <option value="SATIŞ">SATIŞ</option>
                        <option value="İADE">İADE</option>
                        <option value="İKİSİDE">İKİSİDE</option>
                    </select>
                </div>
                <div>
                    <label for="f-product-type" class="block text-sm font-medium text-gray-300 mb-1">Product Type</label>
                    <select id="f-product-type" class="form-select">
                        <option value="">All</option>
                        <option value="İLAÇ">İLAÇ</option>
                        <option value="GÜBRE">GÜBRE</option>
                        <option value="KÖMÜR">KÖMÜR</option>
                        <option value="TOHUM">TOHUM</option>
                        <option value="FİDE">FİDE</option>
                        <option value="ARI">ARI</option>
                        <option value="DİĞER">DİĞER</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button id="filter-btn" class="btn btn-primary w-full">Search</button>
                    <button id="reset-filter-btn" class="btn btn-secondary w-full">Reset</button>
                </div>
            </div>

            <!-- Transaction Table -->
            <div class="bg-gray-700 rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Product Type</th>
                                <th>Product Name</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Price</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="no-transactions" class="text-center p-8 text-gray-400" style="display: none;">
                    No transactions found.
                </div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content" style="display: none;">
            <h1 class="text-3xl font-bold mb-6">Manage Customers</h1>
            <!-- Add Customer Form -->
            <form id="customer-form" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-700 p-6 rounded-lg shadow-lg">
                <div>
                    <label for="c-name" class="block text-sm font-medium text-gray-300 mb-1">Customer Name</label>
                    <input type="text" id="c-name" class="form-input" placeholder="Full Name" required>
                </div>
                <div>
                    <label for="c-phone" class="block text-sm font-medium text-gray-300 mb-1">Phone (Optional)</label>
                    <input type="tel" id="c-phone" class="form-input" placeholder="0555...">
                </div>
                <div class="flex items-end">
                    <button type="submit" class="btn btn-primary w-full">
                        <svg id="icon-user-plus" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="22" x2="16" y1="11" y2="11"></line></svg>
                        Add Customer
                    </button>
                </div>
            </form>
            
            <!-- Customer List -->
            <div class="bg-gray-700 rounded-lg shadow-lg overflow-hidden">
                 <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Products Tab -->
        <div id="products" class="tab-content" style="display: none;">
            <h1 class="text-3xl font-bold mb-6">Manage Products</h1>
            <!-- Add Product Form -->
            <form id="product-form" class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-700 p-6 rounded-lg shadow-lg">
                <div>
                    <label for="p-name" class="block text-sm font-medium text-gray-300 mb-1">Product Name</label>
                    <input type="text" id="p-name" class="form-input" placeholder="Product Name" required>
                </div>
                 <div>
                    <label for="p-type" class="block text-sm font-medium text-gray-300 mb-1">Product Type</label>
                    <select id="p-type" class="form-select">
                        <option value="İLAÇ">İLAÇ</option>
                        <option value="GÜBRE">GÜBRE</option>
                        <option value="DİĞER">DİĞER</option>
                    </select>
                </div>
                <div>
                    <label for="p-price" class="block text-sm font-medium text-gray-300 mb-1">Price</label>
                    <input type="number" id="p-price" class="form-input" min="0" step="any" placeholder="0.00" required>
                </div>
                <div class="flex items-end">
                    <button type="submit" class="btn btn-primary w-full">
                         <svg id="icon-package-plus" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 16h6"></path><path d="M19 13v6"></path><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"></path><path d="m7.5 4.6-1-1.16"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" x2="12" y1="22.08" y2="12"></line></svg>
                        Add Product
                    </button>
                </div>
            </form>
            
            <!-- Product List -->
            <div class="bg-gray-700 rounded-lg shadow-lg overflow-hidden">
                 <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Data Import Tab -->
        <div id="import" class="tab-content" style="display: none;">
            <h1 class="text-3xl font-bold mb-6">Data Import</h1>
            <div class="bg-gray-700 p-6 rounded-lg shadow-lg">
                <p class="text-gray-300 mb-4">
                    To get started, please copy and paste your data from your CSV files into the text boxes below.
                    This only needs to be done once. The data will be saved in your browser.
                </p>
                
                <div class="mb-4">
                    <label for="import-transactions" class="block text-sm font-medium text-gray-300 mb-2">1. Transactions (from 'ANA SAYFA.csv')</label>
                    <textarea id="import-transactions" rows="8" class="form-input" placeholder="TARİH,ADI SOYADI,VERESİYE/SATIŞ,MALIN CİNSİ,ÇEŞİT,MİKTAR,ADET&#10;2025-01-16,ERDAL UYSAL,VERESİYE,İLAÇ,Stomp® Aqua,1,TANE&#10;..."></textarea>
                </div>

                <div class="mb-4">
                    <label for="import-products" class="block text-sm font-medium text-gray-300 mb-2">2. Products (from 'İLAÇ FİYATLARI.csv' and 'GÜBRE FİYATLARI.csv')</label>
                    <textarea id="import-products" rows="8" class="form-input" placeholder="ÜRÜN ADI,FİYAT&#10;ABG MEK 1.8 EC LT001,750&#10;ACTIWAVE - 10 Lt ,5000&#10;..."></textarea>
                </div>
                
                <button id="import-btn" class="btn btn-primary">
                    <svg id="icon-database" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5v14a9 3 0 0 0 18 0V5"></path><path d="M3 12a9 3 0 0 0 18 0"></path></svg>
                    Import and Save Data
                </button>
            </div>
        </div>

    </main>

    <!-- Global Alert/Toast -->
    <div id="toast" class="fixed bottom-8 right-8 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ease-out">
        <span id="toast-message"></span>
    </div>

    <script>
        // --- DATABASE HELPERS (using localStorage) ---
        const DB = {
            // Get data from localStorage
            get: (key) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            },
            // Save data to localStorage
            set: (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
            },
            // Generate a unique ID
            generateId: () => {
                return '_' + Math.random().toString(36).substr(2, 9);
            }
        };

        // --- APP STATE ---
        let state = {
            transactions: [],
            customers: [],
            products: []
        };

        // --- UTILITY FUNCTIONS ---
        
        /**
         * Formats a number as Turkish Lira
         * @param {number} amount
         * @returns {string}
         */
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return num.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
        }
        
        /**
         * Show a toast message
         * @param {string} message
         * @param {string} type - 'success' or 'error'
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            if (type === 'error') {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }
            
            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        /**
         * Gets today's date in YYYY-MM-DD format
         * @returns {string}
         */
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // --- DATA IMPORT LOGIC ---
        
        document.getElementById('import-btn').addEventListener('click', () => {
            try {
                // 1. Import Transactions
                const transactionsCSV = document.getElementById('import-transactions').value;
                if (transactionsCSV) {
                    const parsedTransactions = Papa.parse(transactionsCSV, { header: true, skipEmptyLines: true }).data;
                    const formattedTransactions = parsedTransactions.map(t => ({
                        id: DB.generateId(),
                        date: t['TARİH'] || getTodayDate(),
                        customer: (t['ADI SOYADI'] || 'İSİMSİZ').trim(),
                        type: (t['VERESİYE/SATIŞ'] || 'SATIŞ').trim(),
                        productType: (t['MALIN CİNSİ'] || 'DİĞER').trim(),
                        productName: (t['ÇEŞİT'] || 'Bilinmeyen Ürün').trim(),
                        quantity: parseFloat(t['MİKTAR'] || 0),
                        unit: (t['ADET'] || 'TANE').trim(),
                        price: parseFloat(t['FİYAT'] || 0), // Assuming price is NOT in ANA SAYFA.csv
                        total: parseFloat(t['TOPLAM'] || 0) // Assuming total is NOT in ANA SAYFA.csv
                    }));
                    
                    // We need to find prices from the product list
                    
                    DB.set('transactions', formattedTransactions);
                    state.transactions = formattedTransactions;
                    console.log('Imported transactions:', formattedTransactions);
                }
                
                // 2. Import Products
                const productsCSV = document.getElementById('import-products').value;
                if (productsCSV) {
                    const parsedProducts = Papa.parse(productsCSV, { header: true, skipEmptyLines: true }).data;
                    const productMap = new Map(); // Use map to handle duplicates
                    
                    parsedProducts.forEach(p => {
                        const name = p['ÜRÜN ADI'] || p['İLAÇ ADI'] || p['GÜBRE ADI'];
                        const price = parseFloat(p['FİYAT'] || 0);
                        if (name && price > 0 && !productMap.has(name.trim())) {
                            productMap.set(name.trim(), {
                                id: DB.generateId(),
                                name: name.trim(),
                                // Simple type guessing
                                type: name.toLowerCase().includes('lt') || name.toLowerCase().includes('ec') ? 'İLAÇ' : 'GÜBRE',
                                price: price
                            });
                        }
                    });
                    
                    const formattedProducts = Array.from(productMap.values());
                    DB.set('products', formattedProducts);
                    state.products = formattedProducts;
                    console.log('Imported products:', formattedProducts);
                }
                
                // 3. Auto-generate customers from transactions
                const customerSet = new Set(state.transactions.map(t => t.customer));
                const existingCustomers = new Set(DB.get('customers').map(c => c.name));
                const newCustomers = [];
                
                customerSet.forEach(name => {
                    if (!existingCustomers.has(name) && name.toLowerCase() !== 'i̇si̇msi̇z') {
                        newCustomers.push({
                            id: DB.generateId(),
                            name: name,
                            phone: ''
                        });
                    }
                });
                
                const allCustomers = [...DB.get('customers'), ...newCustomers];
                DB.set('customers', allCustomers);
                state.customers = allCustomers;
                
                // 4. Update transactions with prices from product list
                state.transactions.forEach(t => {
                    if (t.price === 0 && t.total === 0) {
                        const product = state.products.find(p => p.name === t.productName);
                        if (product) {
                            t.price = product.price;
                            t.total = t.price * t.quantity;
                        }
                    } else if (t.price === 0 && t.total > 0 && t.quantity > 0) {
                        t.price = t.total / t.quantity;
                    }
                });
                DB.set('transactions', state.transactions);

                showToast('Data imported successfully!', 'success');
                // Refresh all views
                loadInitialData();
                showTab('dashboard');

            } catch (error) {
                console.error('Import failed:', error);
                showToast('Error during import. Check console.', 'error');
            }
        });

        // --- TAB SWITCHING ---
        let currentTab = 'dashboard';
        const tabs = document.querySelectorAll('.tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        
        function showTab(tabId) {
            // Hide all tabs
            tabs.forEach(tab => {
                tab.style.display = 'none';
            });
            // Show selected tab
            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.style.display = 'block';
            }
            
            // Update button styles
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            const activeButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            currentTab = tabId;
            
            // Refresh data for specific tabs
            if (tabId === 'dashboard') {
                renderDashboard();
            } else if (tabId === 'transactions') {
                renderTransactionTable(state.transactions);
            } else if (tabId === 'customers') {
                renderCustomerTable();
            } else if (tabId === 'products') {
                renderProductTable();
            } else if (tabId === 'newTransaction') {
                updateDatalists();
                document.getElementById('t-date').value = getTodayDate();
            }
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboard() {
            let totalTransactions = state.transactions.length;
            let totalCredit = 0;
            let totalSales = 0;
            const customerBalances = new Map();

            state.transactions.forEach(t => {
                const total = parseFloat(t.total) || 0;
                
                if (t.type === 'VERESİYE' || t.type === 'İKİSİDE') {
                    totalCredit += total;
                }
                if (t.type === 'SATIŞ' || t.type === 'İKİSİDE') {
                    totalSales += total;
                }
                
                // Update customer balances
                const currentBalance = customerBalances.get(t.customer) || 0;
                // Note: This is a simple sum, not a real balance sheet.
                // A real balance would factor in payments.
                customerBalances.set(t.customer, currentBalance + total);
            });
            
            document.getElementById('total-transactions').textContent = totalTransactions;
            document.getElementById('total-credit').textContent = formatCurrency(totalCredit);
            document.getElementById('total-sales').textContent = formatCurrency(totalSales);
            document.getElementById('total-customers').textContent = state.customers.length;
            
            // Render customer balances table
            const balanceBody = document.getElementById('customer-balances-table');
            balanceBody.innerHTML = '';
            
            // Sort by balance descending
            const sortedBalances = [...customerBalances.entries()].sort((a, b) => b[1] - a[1]);
            
            if (sortedBalances.length === 0) {
                 balanceBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-400">No customer data.</td></tr>';
                 return;
            }
            
            sortedBalances.forEach(([name, balance]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${formatCurrency(balance)}</td>
                    <td><span class="px-2 py-1 rounded-full text-xs font-medium ${balance > 10000 ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}">
                        ${balance > 10000 ? 'High' : 'Normal'}
                    </span></td>
                `;
                balanceBody.appendChild(row);
            });
        }

        // --- NEW TRANSACTION LOGIC ---
        const transactionForm = document.getElementById('transaction-form');
        const tQuantity = document.getElementById('t-quantity');
        const tPrice = document.getElementById('t-price');
        const tTotal = document.getElementById('t-total');
        const tProductName = document.getElementById('t-product-name');

        function updateTransactionTotal() {
            const quantity = parseFloat(tQuantity.value) || 0;
            const price = parseFloat(tPrice.value) || 0;
            const total = quantity * price;
            tTotal.value = formatCurrency(total);
        }
        
        tQuantity.addEventListener('input', updateTransactionTotal);
        tPrice.addEventListener('input', updateTransactionTotal);
        
        tProductName.addEventListener('input', (e) => {
            const productName = e.target.value;
            const product = state.products.find(p => p.name === productName);
            if (product) {
                tPrice.value = product.price;
                updateTransactionTotal();
            }
        });

        transactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newTransaction = {
                id: DB.generateId(),
                date: document.getElementById('t-date').value,
                customer: document.getElementById('t-customer').value.trim(),
                type: document.getElementById('t-type').value,
                productType: document.getElementById('t-product-type').value,
                productName: document.getElementById('t-product-name').value.trim(),
                quantity: parseFloat(tQuantity.value),
                unit: document.getElementById('t-unit').value,
                price: parseFloat(tPrice.value),
                total: (parseFloat(tQuantity.value) * parseFloat(tPrice.value))
            };
            
            // Add to state and DB
            state.transactions.unshift(newTransaction); // Add to beginning
            DB.set('transactions', state.transactions);
            
            // Check if it's a new customer and add them
            if (!state.customers.find(c => c.name === newTransaction.customer)) {
                const newCustomer = {
                    id: DB.generateId(),
                    name: newTransaction.customer,
                    phone: ''
                };
                state.customers.push(newCustomer);
                DB.set('customers', state.customers);
            }
            
            showToast('Transaction saved!', 'success');
            transactionForm.reset();
            document.getElementById('t-date').value = getTodayDate();
            
            // Go to transactions tab to see the new entry
            showTab('transactions');
        });

        // --- TRANSACTION LIST / SEARCH LOGIC ---
        const filterBtn = document.getElementById('filter-btn');
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        
        function renderTransactionTable(transactions) {
            const tableBody = document.getElementById('transaction-table-body');
            const noDataEl = document.getElementById('no-transactions');
            tableBody.innerHTML = '';
            
            if (!transactions || transactions.length === 0) {
                noDataEl.style.display = 'block';
                return;
            }
            
            noDataEl.style.display = 'none';
            
            transactions.forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${t.date}</td>
                    <td>${t.customer}</td>
                    <td>${t.type}</td>
                    <td>${t.productType}</td>
                    <td>${t.productName}</td>
                    <td>${t.quantity}</td>
                    <td>${t.unit}</td>
                    <td>${formatCurrency(t.price)}</td>
                    <td>${formatCurrency(t.total)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteTransaction('${t.id}')">
                            <svg id="icon-trash" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        window.deleteTransaction = (id) => {
            if (confirm('Are you sure you want to delete this transaction?')) {
                state.transactions = state.transactions.filter(t => t.id !== id);
                DB.set('transactions', state.transactions);
                renderTransactionTable(state.transactions); // Re-render current view
                showToast('Transaction deleted.', 'success');
            }
        }
        
        filterBtn.addEventListener('click', () => {
            const customerFilter = document.getElementById('f-customer').value.toLowerCase();
            const typeFilter = document.getElementById('f-type').value;
            const productTypeFilter = document.getElementById('f-product-type').value;
            
            const filteredTransactions = state.transactions.filter(t => {
                const customerMatch = t.customer.toLowerCase().includes(customerFilter);
                const typeMatch = !typeFilter || t.type === typeFilter;
                const productTypeMatch = !productTypeFilter || t.productType === productTypeFilter;
                
                return customerMatch && typeMatch && productTypeMatch;
            });
            
            renderTransactionTable(filteredTransactions);
        });
        
        resetFilterBtn.addEventListener('click', () => {
             document.getElementById('f-customer').value = '';
             document.getElementById('f-type').value = '';
             document.getElementById('f-product-type').value = '';
             renderTransactionTable(state.transactions);
        });

        // --- CUSTOMER MANAGEMENT ---
        const customerForm = document.getElementById('customer-form');
        
        function renderCustomerTable() {
            const tableBody = document.getElementById('customer-table-body');
            tableBody.innerHTML = '';
            
            if (state.customers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-400">No customers saved.</td></tr>';
                return;
            }

            state.customers.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${c.name}</td>
                    <td>${c.phone || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCustomer('${c.id}')">
                            <svg id="icon-trash" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        customerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('c-name').value.trim();
            const phone = document.getElementById('c-phone').value.trim();
            
            if (!name) {
                showToast('Customer name is required.', 'error');
                return;
            }
            
            if (state.customers.find(c => c.name.toLowerCase() === name.toLowerCase())) {
                showToast('A customer with this name already exists.', 'error');
                return;
            }
            
            const newCustomer = {
                id: DB.generateId(),
                name: name,
                phone: phone
            };
            
            state.customers.push(newCustomer);
            DB.set('customers', state.customers);
            
            renderCustomerTable();
            updateDatalists();
            customerForm.reset();
            showToast('Customer added!', 'success');
        });
        
        window.deleteCustomer = (id) => {
            if (confirm('Are you sure you want to delete this customer? This cannot be undone.')) {
                state.customers = state.customers.filter(c => c.id !== id);
                DB.set('customers', state.customers);
                renderCustomerTable();
                updateDatalists();
                showToast('Customer deleted.', 'success');
            }
        }
        
        // --- PRODUCT MANAGEMENT ---
        const productForm = document.getElementById('product-form');

        function renderProductTable() {
            const tableBody = document.getElementById('product-table-body');
            tableBody.innerHTML = '';
            
            if (state.products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-400">No products saved. Import or add them.</td></tr>';
                return;
            }

            state.products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.type || 'DİĞER'}</td>
                    <td>${formatCurrency(p.price)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">
                            <svg id="icon-trash" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('p-name').value.trim();
            const type = document.getElementById('p-type').value;
            const price = parseFloat(document.getElementById('p-price').value);
            
            if (!name || !price) {
                showToast('Product name and price are required.', 'error');
                return;
            }
            
            if (state.products.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast('A product with this name already exists.', 'error');
                return;
            }
            
            const newProduct = {
                id: DB.generateId(),
                name: name,
                type: type,
                price: price
            };
            
            state.products.push(newProduct);
            DB.set('products', state.products);
            
            renderProductTable();
            updateDatalists();
            productForm.reset();
            showToast('Product added!', 'success');
        });
        
        window.deleteProduct = (id) => {
            if (confirm('Are you sure you want to delete this product?')) {
                state.products = state.products.filter(p => p.id !== id);
                DB.set('products', state.products);
                renderProductTable();
                updateDatalists();
                showToast('Product deleted.', 'success');
            }
        }
        
        // --- AUTOCOMPLETE DATALISTS ---
        function updateDatalists() {
            const customerDatalist = document.getElementById('customer-list');
            customerDatalist.innerHTML = '';
            state.customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                customerDatalist.appendChild(option);
            });
            
            const productDatalist = document.getElementById('product-list');
            productDatalist.innerHTML = '';
            state.products.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                productDatalist.appendChild(option);
            });
        }
        
        // --- INITIALIZE APP ---
        function loadInitialData() {
            state.transactions = DB.get('transactions');
            state.customers = DB.get('customers');
            state.products = DB.get('products');
            
            // If no data, go to import tab
            if (state.transactions.length === 0 && state.products.length === 0) {
                showTab('import');
            } else {
                showTab('dashboard');
            }
            
            // Always update datalists and tables on load
            updateDatalists();
            renderTransactionTable(state.transactions);
            renderCustomerTable();
            renderProductTable();
            renderDashboard();
        }
        
        // --- REPLACE ICON PLACEHOLDERS ---
        // This is a simple way to load Lucide icons after the page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide) {
                document.querySelectorAll('[id^="icon-"]').forEach(el => {
                    const iconName = el.id.replace('icon-', '');
                    // Capitalize first letter (e.g., 'book' -> 'Book')
                    const iconPascal = iconName.charAt(0).toUpperCase() + iconName.slice(1).replace(/-(\w)/g, (m, g) => g.toUpperCase());
                    
                    const svg = window.lucide.createElement(window.lucide[iconPascal]);
                    svg.setAttribute('width', el.getAttribute('width') || '20');
                    svg.setAttribute('height', el.getAttribute('height') || '20');
                    svg.setAttribute('stroke', el.getAttribute('stroke') || 'currentColor');
                    el.parentNode.replaceChild(svg, el);
                });
            } else {
                console.warn('Lucide icons could not be loaded.');
            }
            
            // Load initial data
            loadInitialData();
        });

    </script>
</body>
</html>
